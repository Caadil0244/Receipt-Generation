{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-green">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('dashboard') }}" class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" name="search" 
                                   placeholder="Search receipts, customers..." 
                                   value="{{ request.args.get('search', '') }}">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" name="filter_type">
                                <option value="">All Types</option>
                                <option value="receipt" {{ 'selected' if request.args.get('filter_type') == 'receipt' }}>Receipts</option>
                                <option value="customer" {{ 'selected' if request.args.get('filter_type') == 'customer' }}>Customers</option>
                                <option value="amount" {{ 'selected' if request.args.get('filter_type') == 'amount' }}>Amount</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" name="date_filter" 
                                   value="{{ request.args.get('date_filter', '') }}" 
                                   placeholder="Filter by date">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-success mb-3">
                <i class="fas fa-chart-line me-2"></i>Dashboard Overview
            </h2>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stats-card card-green h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">
                        <i class="fas fa-dollar-sign me-2"></i>Total Paid
                    </h5>
                    <p class="card-text display-6 text-success fw-bold">${{ "%.2f"|format(total_paid) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card card-green h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">
                        <i class="fas fa-balance-scale me-2"></i>Outstanding Balance
                    </h5>
                    <p class="card-text display-6 text-warning fw-bold">${{ "%.2f"|format(total_balance) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card card-green h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">
                        <i class="fas fa-users me-2"></i>Total Customers
                    </h5>
                    <p class="card-text display-6 text-info fw-bold">{{ total_customers }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card card-green h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">
                        <i class="fas fa-receipt me-2"></i>Total Payments
                    </h5>
                    <p class="card-text display-6 text-primary fw-bold">{{ total_payments }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-green">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('add_receipt') }}" class="btn btn-success w-100">
                                <i class="fas fa-plus-circle me-2"></i>Add Receipt
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('view_payments') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-list me-2"></i>View All Payments
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('view_customers') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-users me-2"></i>List Customers
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('view_appointments') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-calendar me-2"></i>View Appointments
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Payments Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-green">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Recent Payments
                    </h5>
                    <div>
                        <span class="badge bg-light text-dark">{{ recent_payments|length }} payments</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if recent_payments %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-success">
                                    <tr>
                                        <th>Receipt #</th>
                                        <th>Customer</th>
                                        <th>Amount Paid</th>
                                        <th>Balance</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in recent_payments %}
                                    <tr>
                                        <td><strong>{{ payment.receipt_number }}</strong></td>
                                        <td>{{ payment.customer_name }}</td>
                                        <td class="text-success fw-bold">${{ "%.2f"|format(payment.amount_paid) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(payment.balance) }}</td>
                                        <td>{{ payment.receipt_date.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('view_receipt', receipt_id=payment.id) }}" 
                                                   class="btn btn-sm btn-outline-info" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="{{ url_for('edit_receipt', receipt_id=payment.id) }}" 
                                                   class="btn btn-sm btn-outline-warning" title="Edit Receipt">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteReceipt('{{ payment.id }}')" title="Delete Receipt">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                                <a href="{{ url_for('generate_receipt_pdf', receipt_id=payment.id) }}" 
                                                   class="btn btn-sm btn-outline-primary" title="Download PDF">
                                                    <i class="fas fa-file-pdf"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center">No recent payments found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Upcoming Appointments -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card card-green h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Upcoming Appointments
                    </h5>
                </div>
                <div class="card-body">
                    {% if upcoming_appointments %}
                        <div class="list-group list-group-flush">
                            {% for appointment in upcoming_appointments %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ appointment.customer.name }}</h6>
                                        <small class="text-muted">{{ appointment.description }}</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-success rounded-pill">
                                            {{ appointment.appointment_date.strftime('%m/%d') }}
                                        </span>
                                        <br>
                                        <small class="text-muted">{{ appointment.appointment_date.strftime('%H:%M') }}</small>
                                        <div class="btn-group btn-group-sm ms-2" role="group">
                                            <a href="{{ url_for('view_appointment', appointment_id=appointment.id) }}" 
                                               class="btn btn-outline-info" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('edit_appointment', appointment_id=appointment.id) }}" 
                                               class="btn btn-outline-warning" title="Edit Appointment">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-danger" 
                                                    onclick="deleteAppointment('{{ appointment.id }}')" title="Delete Appointment">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center">No upcoming appointments.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Receipts Trend Chart -->
        <div class="col-md-6">
            <div class="card card-green h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Payment Trends
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="receiptsChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Receipts Chart
        var ctx = document.getElementById('receiptsChart').getContext('2d');
        var receiptsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_labels | tojson }},
                datasets: [{
                    label: 'Amount Paid',
                    data: {{ chart_data | tojson }},
                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Delete Receipt Function
        function deleteReceipt(receiptId) {
            if (confirm('Are you sure you want to delete this receipt?')) {
                fetch(`/delete_receipt/${receiptId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting receipt: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting receipt');
                });
            }
        }

        // Delete Appointment Function
        function deleteAppointment(appointmentId) {
            if (confirm('Are you sure you want to delete this appointment?')) {
                fetch(`/delete_appointment/${appointmentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting appointment: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting appointment');
                });
            }
        }
    </script>
{% endblock %}
