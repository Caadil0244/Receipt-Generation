{% extends "base.html" %}

{% block title %}Customer Details{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-success mb-3">
            <i class="fas fa-user-circle me-2"></i>Customer Details
        </h2>
    </div>
</div>

<div class="card card-green mb-4">
    <div class="card-body">
        <h5 class="card-title">{{ customer.name }}</h5>
        <p class="card-text"><strong>Phone:</strong> {{ customer.phone or 'N/A' }}</p>
        <p class="card-text"><strong>Total Payments:</strong> {{ customer.receipts|length }}</p>
        <p class="card-text"><strong>Total Amount Paid:</strong> ${{ "%.2f"|format(customer.receipts|map(attribute='amount_paid')|sum) }}</p>
        {% set latest_receipt = customer.receipts|sort(attribute='receipt_date', reverse=true)|first %}
        <p class="card-text"><strong>Last Payment Date:</strong> {{ latest_receipt.receipt_date.strftime('%Y-%m-%d') if latest_receipt else 'N/A' }}</p>

        <hr>

        <div class="d-flex justify-content-end">
            <a href="{{ url_for('edit_customer', customer_id=customer.id) }}" class="btn btn-sm btn-warning me-2">
                <i class="fas fa-edit me-1"></i> Edit Customer
            </a>
            <button type="button" class="btn btn-sm btn-danger" onclick="deleteCustomer('{{ customer.id }}')">
                <i class="fas fa-trash-alt me-1"></i> Delete Customer
            </button>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('view_customers') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Customers
    </a>
</div>

<script>
function deleteCustomer(customerId) {
    if (confirm('Are you sure you want to delete this customer and all associated data (receipts, appointments)?')) {
        fetch(`/delete_customer/${customerId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Customer and associated data deleted successfully!');
                window.location.href = "{{ url_for('view_customers') }}";
            } else {
                alert('Error deleting customer: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the customer.');
        });
    }
}
</script>
{% endblock %}
